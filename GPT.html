<head>
    <meta charset="UTF-8">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
    <style>
        body {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        h1, .search-container {
            text-align: center;
            color: black;
        }

        .search-container {
            padding: 20px;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            background: transparent;
        }

        .search-container input {
            padding: 20px;
            width: 90%;
            height: 60px;
            border-radius: 30px;
            border: 3px solid #444;
            background: #01dfff;
            box-shadow: 8px 8px 15px #44dede, -8px -8px 15px #58ffff;
            transition: all 0.3s ease-in-out;
            font-size: 16px;
            color: #333;
            text-align: center;
        }

        .search-container input:focus {
            box-shadow: inset 8px 8px 15px #ffffff, inset -8px -8px 15px #ffffff, 
                        8px 8px 15px #44dede, -8px -8px 15px #58ffff;
            outline: none;
            border: 3px solid #333;
        }

        /* Adjust main content to sit below the search container */
        #mainContent {
            margin-top: 100px; /* Height of the search-container + some space */
        }

        .table-container {
            width: 100%;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            color: black;
            background: white;
            border: 2px solid black;
        }

        table th, table td {
            border: 2px solid black;
        }

        table th {
            border: 2px solid white;
            background-color: black;
            color: white;
            font-weight: bold;
        }

        table td {
            font-size: 20px;
            font-family: 'Roboto', sans-serif;
        }

        th, td {
            border: 2px solid white;
            padding: 10px;
            text-align: center;
            white-space: nowrap;
        }

        th {
            background: black;
            color: white;
            font-weight: bold;
            font-size: 25px;
        }

        .table-plastik th {
            background: black;
        }

        .download-container {
            text-align: center;
            margin: 20px 0;
            position: fixed;
            bottom: 0;
            width: 100%;
            padding: 10px 0;
            z-index: 1000;
            background: transparent;
        }

        .download-container button {
            display: inline-block;
            margin: 0 3px;
            text-align: center;
            background-color: transparent;
            color: #01dfff;
            border: 2px solid #01dfff;
            padding: 10px 20px;
            font-size: 30px;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Search Container -->
    <div id="search-container">
        <div class="search-container">
            <input type="text" id="searchInput" onkeyup="searchTable()" placeholder="Cari data di tabel...">
        </div>
    </div>  

    <!-- Main Content -->
    <div id="mainContent">
        <h1>PLASTIK</h1>
        <div class="table-container" id="tablePlastik">
            <table id="dataTablePlastik" class="table-plastik">
                <thead>
                    <tr>
                        <th class="no-column" rowspan="3">NO</th>
                        <th class="detail-barang" colspan="3">DETAIL BARANG</th>
                        <th class="analisis-pasar" colspan="14">ANALISIS PASAR</th>
                    </tr>
                    <tr>
                        <th class="jenis-barang" rowspan="2">UKURAN</th>
                        <th class="kode" colspan="2">KODE</th>
                        <th class="harga" colspan="8">HARGA</th>
                        <th class="stok" colspan="2">STOK</th>
                        <th class="tanggal" colspan="2">TANGGAL</th>
                        <th class="aksi" colspan="2">AKSI</th> 
                    </tr>
                    <tr>
                        <th class="kode-gudang">TOKO</th>
                        <th class="kode-gudang">GUDANG</th>
                        <th class="dus">DUS/BALL</th>
                        <th class="pack">1 PACK</th>
                        <th class="pcs">1 PCS</th>
                        <th class="gram-1000">1000 GRAM</th>
                        <th class="gram-500">500 GRAM</th>
                        <th class="gram-250">250 GRAM</th>
                        <th class="gram-100">100 GRAM</th>
                        <th class="gram-50">50 GRAM</th>
                        <th class="gudang">GUDANG</th>
                        <th class="toko">TOKO</th>
                        <th class="masuk">MASUK</th>
                        <th class="keluar">KELUAR</th>
                        <th class="save">SAVE</th> 
                        <th class="hapus">HAPUS</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>   
    </div>

   <div class="download-container">
    <!-- Tombol Pertama untuk Download -->
    <button class="download-button" onclick="downloadTable()">
        <i class="fas fa-download"></i>
    </button>
    <!-- Tombol Kedua untuk Apload -->
    <button class="download-button" onclick="triggerUpdateFile()">
        <i class="fas fa-upload"></i>
    </button>
</div>

<!-- External Scripts -->
<script src="DW.js"></script>
<script src="z.js"></script>

<script>
// Fungsi untuk mengunduh data dalam format JSON
function downloadTable() {
    const data = [];

    // Iterasi melalui kategori dalam defaultData
    PlastikDB.defaultData.forEach(category => {
        category.items.forEach(item => {
            const rowData = {
                category: category.category,
                NO: item.NO,
                BARANG: item.BARANG,
                KODE_TOKO: item.KODE_TOKO,
                KODE_GUDANG: item.KODE_GUDANG,
                "DUS/BALL": item.HARGA["DUS/BALL"],
                "1 PACK": item.HARGA["1 PACK"],
                "1 PCS": item.HARGA["1 PCS"],
                "1000 GRAM": item.HARGA["1000 GRAM"],
                "500 GRAM": item.HARGA["500 GRAM"],
                "250 GRAM": item.HARGA["250 GRAM"],
                "100 GRAM": item.HARGA["100 GRAM"],
                "50 GRAM": item.HARGA["50 GRAM"],
                "STOK.GUDANG": item.STOK.GUDANG,
                "STOK.TOKO": item.STOK.TOKO,
                MASUK: item.TANGGAL.MASUK,
                KELUAR: item.TANGGAL.KELUAR
            };
            data.push(rowData);  // Menambahkan data item ke dalam array data
        });
    });

    // Membuat elemen link sementara untuk mengunduh file JSON
    const downloadLink = document.createElement("a");
    const jsonBlob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json;charset=utf-8;" });
    const url = URL.createObjectURL(jsonBlob);
    downloadLink.setAttribute("href", url);
    downloadLink.setAttribute("download", "tabel_plastik.json");
    downloadLink.click();
    URL.revokeObjectURL(url);
}

// Fungsi untuk men-trigger pemilihan file dan memulai proses upload
function triggerUpdateFile() {
    const inputElement = document.createElement('input');
    inputElement.type = 'file';
    inputElement.accept = '.json';
    inputElement.addEventListener('change', handleFileSelect);
    inputElement.click(); // Simulasi klik untuk membuka dialog pemilihan file
}

// Fungsi untuk menangani pemilihan file
function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) {
        console.error("Silakan pilih file JSON terlebih dahulu.");
        return;
    }

    const reader = new FileReader();
    reader.onload = function(event) {
        try {
            const jsonData = JSON.parse(event.target.result);
            uploadData(jsonData); // Kirim data untuk disimpan ke IndexedDB
        } catch (error) {
            console.error("File JSON tidak valid.");
        }
    };
    reader.readAsText(file); // Membaca file yang dipilih
}

// Fungsi untuk meng-upload data ke IndexedDB
function uploadData(jsonData) {
    const transaction = PlastikDB.db.transaction([PlastikDB.storeName], "readwrite");
    const store = transaction.objectStore(PlastikDB.storeName);

    // Iterasi dan masukkan setiap data yang ada pada jsonData ke IndexedDB
    jsonData.forEach(item => {
        const request = store.put(item);
        request.onsuccess = () => {
            console.log("Data berhasil di-upload ke IndexedDB.");
        };
        request.onerror = (e) => {
            console.error("Terjadi kesalahan saat meng-upload data:", e.target.error);
        };
    });

    // Selesaikan transaksi
    transaction.oncomplete = () => {
        console.log("Semua data telah diproses.");
    };
    transaction.onerror = (e) => {
        console.error("Terjadi kesalahan saat transaksi:", e.target.error);
    };
}

PlastikDB.openDB();
</script>
