<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="table.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
<style>
#downloadButton {
    display: block;
    margin: 20px auto;
    text-align: center;
    background-color: transparent;
    color: #01dfff;
    border: 2px solid #01dfff;
    padding: 10px 20px;
    font-size: 30px;
    border-radius: 5px;
    cursor: pointer;
}

</style>
</head>
<body>
    <div id="search-container">
        <div class="search-container">
            <input type="text" id="searchInput" onkeyup="searchTable()" placeholder="Cari data di tabel...">
        </div>
    </div>

    <div id="mainContent">
        <h1>KUE</h1>
        <div class="table-container" id="tableKue">
            <table id="dataTablekue">
                <thead>
                    <tr>
                        <th class="no-column" rowspan="3">NO</th>
                        <th class="detail-barang" colspan="3">DETAIL BARANG</th>
                        <th class="analisis-pasar" colspan="14">ANALISIS PASAR</th>
                    </tr>
                    <tr>
                        <th class="jenis-barang" rowspan="2">BARANG</th>
                        <th class="kode" colspan="2">KODE</th>
                        <th class="harga" colspan="6">HARGA</th>
                        <th class="stok" colspan="2">STOK</th>
                        <th class="tanggal" colspan="3">TANGGAL</th>
                        <th class="aksi" colspan="2">AKSI</th> <!-- Kolom AKSI untuk SAVE dan HAPUS -->
                    </tr>
                    <tr>
                        <th class="kode-gudang">TOKO</th>
                        <th class="kode-gudang">GUDANG</th>
                        <th class="dus">DUS / BALL</th>
                        <th class="gram-1000">1000 GRAM</th>
                        <th class="gram-500">500 GRAM</th>
                        <th class="gram-250">250 GRAM</th>
                        <th class="gram-100">100 GRAM</th>
                        <th class="gram-50">50 GRAM</th>
                        <th class="gudang">GUDANG</th>
                        <th class="toko">TOKO</th>
                        <th class="expayer">EXPAYER</th>
                        <th class="masuk">MASUK</th>
                        <th class="keluar">KELUAR</th>
                        <th class="save">SAVE</th> <!-- Kolom SAVE -->
                        <th class="hapus">HAPUS</th> <!-- Kolom HAPUS -->
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
    </div>
    <button id="downloadButton" onclick="downloadTable()" style="margin-top: 20px;">
        <i class="fas fa-download"></i> <!-- Menggunakan ikon unduh dari Font Awesome -->
    </button>
    <script src="karambia.js"></script>
    <script>
        // Namespace untuk Kue
        const KueDB = {
            dbName: "karambia",
            storeName: "items",
            db: null,
            defaultData: [
                { category: 'Tepung', items: [] },
                { category: 'Mesis', items: [] },
                { category: 'Selai', items: [] },
                { category: 'Susu', items: [] },
                { category: 'Gula', items: [] },
                { category: 'Agar', items: [] },
                { category: 'Puding', items: [] },
                { category: 'Nutrijel', items: [] },
                { category: 'Pewarna', items: [] },
                { category: 'Minuman', items: [] },
                { category: 'Margarine', items: [] },
                { category: 'Coklat bubuk', items: [] },
                { category: 'Chocolate chip', items: [] },
                { category: 'Bahan pengemulsi', items: [] },
                { category: 'Bahan pengembang', items: [] }
            ],

            openDB: function() {
                const request = indexedDB.open(this.dbName, 1);
                request.onerror = function(event) {
                    console.error("Database error: " + event.target.error);
                };
                request.onupgradeneeded = (event) => {
                    this.db = event.target.result;
                    if (!this.db.objectStoreNames.contains(this.storeName)) {
                        const store = this.db.createObjectStore(this.storeName, { keyPath: 'id', autoIncrement: true });
                        store.createIndex("by_category", "category", { unique: false });
                    }
                };
                request.onsuccess = (event) => {
                    this.db = event.target.result;
                    this.loadDataFromDB();
                };
            },

            saveItemToDB: function(categoryIndex, itemIndex) {
                const item = this.defaultData[categoryIndex].items[itemIndex];
                const transaction = this.db.transaction([this.storeName], "readwrite");
                const store = transaction.objectStore(this.storeName);
                store.put(item);

                transaction.oncomplete = function() {
                    console.log("Item saved to IndexedDB.");
                };

                transaction.onerror = function(event) {
                    console.error("Error saving to IndexedDB:", event.target.error);
                };
            },

            loadDataFromDB: function() {
                const transaction = this.db.transaction([this.storeName], "readonly");
                const store = transaction.objectStore(this.storeName);
                const request = store.getAll();

                request.onsuccess = (event) => {
                    const items = event.target.result;
                    items.forEach(item => {
                        const category = this.defaultData.find(c => c.category === item.category);
                        if (category) {
                            category.items.push(item);
                        } else {
                            this.defaultData.push({ category: item.category, items: [item] });
                        }
                    });
                    this.loadTableFromHtml();
                };

                request.onerror = function(event) {
                    console.error("Error loading data from IndexedDB:", event.target.error);
                };
            },

            deleteItemFromDB: function(categoryIndex, itemIndex) {
                const itemId = this.defaultData[categoryIndex].items[itemIndex].id;
                const transaction = this.db.transaction([this.storeName], "readwrite");
                const store = transaction.objectStore(this.storeName);
                store.delete(itemId);

                transaction.oncomplete = () => {
                    console.log("Item deleted from IndexedDB.");
                    this.loadDataFromDB();
                };

                transaction.onerror = function(event) {
                    console.error("Error deleting from IndexedDB:", event.target.error);
                };
            },

            saveItem: function(categoryIndex, itemIndex) {
                const item = this.defaultData[categoryIndex].items[itemIndex];
                const updatedCells = document.querySelectorAll(`[data-category="${categoryIndex}"][data-item="${itemIndex}"]`);

                updatedCells.forEach(cell => {
                    const columnName = cell.cellIndex;
                    switch (columnName) {
                        case 0: item.NO = cell.textContent; break;
                        case 1: item.BARANG = cell.textContent; break;
                        case 2: item.KODE_TOKO = cell.textContent; break;
                        case 3: item.KODE_GUDANG = cell.textContent; break;
                        case 4: item.HARGA["DUS / BALL"] = cell.textContent; break;
                        case 5: item.HARGA["1000 GRAM"] = cell.textContent; break;
                        case 6: item.HARGA["500 GRAM"] = cell.textContent; break;
                        case 7: item.HARGA["250 GRAM"] = cell.textContent; break;
                        case 8: item.HARGA["100 GRAM"] = cell.textContent; break;
                        case 9: item.HARGA["50 GRAM"] = cell.textContent; break;
                        case 10: item.STOK.GUDANG = cell.textContent; break;
                        case 11: item.STOK.TOKO = cell.textContent; break;
                    }
                });
                this.saveItemToDB(categoryIndex, itemIndex);

                // Sembunyikan tombol save setelah menyimpan
                const saveButton = document.querySelector(`[data-category="${categoryIndex}"][data-item="${itemIndex}"] .save-button`);
                if (saveButton) {
                    saveButton.style.display = 'none';
                }
            },

            deleteItem: function(categoryIndex, itemIndex) {
                this.deleteItemFromDB(categoryIndex, itemIndex);
                this.defaultData[categoryIndex].items.splice(itemIndex, 1);
                this.loadTableFromHtml();
            },

            updateDate: function(categoryIndex, itemIndex, dateType, value) {
                const item = this.defaultData[categoryIndex].items[itemIndex];
                item.TANGGAL[dateType] = value;

                // Tampilkan tombol save setelah ada perubahan
                const saveButton = document.querySelector(`[data-category="${categoryIndex}"][data-item="${itemIndex}"] .save-button`);
                if (saveButton) {
                    saveButton.style.display = 'inline-block';
                }
            },

            addRp: function(element) {
                let value = element.textContent.replace(/[^0-9]/g, ''); // Menghapus karakter non-angka
                if (value === '') {
                    value = '0';
                }
                value = 'Rp ' + value + ',00';
                element.textContent = value;
            }
        };

        // Memanggil fungsi untuk memulai IndexedDB
        KueDB.openDB();

        // Mengatur event blur untuk setiap cell harga
        document.addEventListener("DOMContentLoaded", function() {
            document.querySelectorAll('.currency').forEach(cell => {
                cell.addEventListener('blur', function() {
                    KueDB.addRp(this); // Menambahkan format saat selesai edit
                });
            });
        });
    </script>
</body>
